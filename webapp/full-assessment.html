<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technology Assessment - Interactive Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div>
                <h1 id="appTitle">ğŸ¯ Technology Assessment</h1>
                <p class="subtitle">Interactive SRE, Automation, AI & Audit Capabilities Framework</p>
            </div>
            <div class="header-actions">
                <a href="index.html" class="btn btn-secondary">ğŸ‘¤ Dashboard</a>
                <a href="admin.html" class="btn btn-secondary">âš™ï¸ Admin</a>
                <button class="btn btn-secondary" onclick="reloadAssessment()">
                    ğŸ”„ Reload Data
                </button>
                <button class="btn btn-primary" onclick="exportPDF()">
                    ğŸ“„ Export PDF
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-label">Assessment Progress</span>
                <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;">
                    <span id="progressText">0/48 Questions</span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('assessment')">ğŸ“ Assessment Questions</button>
            <button class="nav-tab" onclick="showSection('dashboard')">ğŸ“Š Dashboard</button>
            <button class="nav-tab" onclick="showSection('maturity')">ğŸ¯ Maturity Analysis</button>
            <button class="nav-tab" onclick="showSection('compliance')">âœ… Compliance</button>
            <button class="nav-tab" onclick="showSection('roadmap')">ğŸ—ºï¸ Roadmap</button>
        </div>

        <!-- Assessment Section -->
        <div id="assessment" class="content-section active">
            <div class="alert alert-info">
                <span>â„¹ï¸</span>
                <div>
                    <strong>Instructions:</strong> Rate each capability on a scale of 1-5, where 1 = Not Implemented, 2 = Initial, 3 = Developing, 4 = Mature, 5 = Optimized. Your responses will automatically update the visualizations in real-time.
                </div>
            </div>

            <!-- Questions will be dynamically generated here -->
            <div id="questionsContainer"></div>

            <div class="card">
                <div class="text-center">
                    <button class="btn btn-success btn-lg" onclick="showSection('dashboard')">
                        ğŸ“Š View Results Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">ğŸ“Š Assessment Results Dashboard</h2>
                        <p class="card-subtitle">Real-time visualization of your technology maturity assessment</p>
                    </div>
                </div>
                
                <div class="score-summary">
                    <div class="score-card">
                        <div class="score-label">Overall Maturity</div>
                        <div class="score-value" id="overallScore">0.0</div>
                        <div class="score-max">/ 5.0</div>
                    </div>
                    <div class="score-card">
                        <div class="score-label">Domain 1</div>
                        <div class="score-value" id="domain1Score">0.0</div>
                        <div class="score-max">/ 5.0</div>
                    </div>
                    <div class="score-card">
                        <div class="score-label">Domain 2</div>
                        <div class="score-value" id="domain2Score">0.0</div>
                        <div class="score-max">/ 5.0</div>
                    </div>
                    <div class="score-card">
                        <div class="score-label">Domain 3</div>
                        <div class="score-value" id="domain3Score">0.0</div>
                        <div class="score-max">/ 5.0</div>
                    </div>
                    <div class="score-card">
                        <div class="score-label">Domain 4</div>
                        <div class="score-value" id="domain4Score">0.0</div>
                        <div class="score-max">/ 5.0</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="overviewChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Maturity Analysis Section -->
        <div id="maturity" class="content-section">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">ğŸ¯ Maturity Radar Analysis</h2>
                        <p class="card-subtitle">Compare current state vs. target state vs. industry benchmark</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">ğŸ“ˆ Domain Breakdown</h2>
                        <p class="card-subtitle">Detailed scoring by assessment domain</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="domainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Compliance Section -->
        <div id="compliance" class="content-section">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">âœ… SOX Compliance Dashboard</h2>
                        <p class="card-subtitle">Compliance status across key control areas</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="soxChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">ğŸ”’ PII Protection Status</h2>
                        <p class="card-subtitle">Data protection levels by category</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="piiChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Roadmap Section -->
        <div id="roadmap" class="content-section">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">ğŸ—ºï¸ Implementation Roadmap</h2>
                        <p class="card-subtitle">Prioritized initiatives based on assessment results</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="roadmapChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">ğŸ“‹ Recommended Actions</h2>
                        <p class="card-subtitle">Priority initiatives based on your assessment</p>
                    </div>
                </div>
                <div id="recommendationsContent">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Evidence Modal -->
    <div id="evidenceModal" class="evidence-modal">
        <div class="evidence-modal-content">
            <div class="evidence-modal-header">
                <h2>ğŸ“ Add Evidence</h2>
                <span class="close-modal" onclick="closeEvidenceModal()">&amp;times;</span>
            </div>
            <input type="hidden" id="modalQuestionId">
            
            <div class="evidence-form-group">
                <label>Evidence Description</label>
                <textarea id="evidenceText" placeholder="Describe your evidence, implementation details, or supporting information..."></textarea>
            </div>
            
            <div class="evidence-form-group">
                <label>Upload Images (Screenshots, Diagrams, etc.)</label>
                <div class="file-upload-area" onclick="document.getElementById('evidenceImages').click()">
                    <label class="file-upload-label">
                        <div class="file-upload-icon">ğŸ“·</div>
                        <div class="file-upload-text">Click to upload images</div>
                        <div class="file-upload-hint">PNG, JPG, GIF up to 10MB each</div>
                    </label>
                    <input type="file" id="evidenceImages" accept="image/*" multiple>
                </div>
            </div>
            
            <div class="evidence-form-group">
                <label>Uploaded Images</label>
                <div id="imagePreview"></div>
            </div>
            
            <div class="evidence-modal-actions">
                <button class="btn-cancel" onclick="closeEvidenceModal()">Cancel</button>
                <button class="btn-save" onclick="saveEvidenceFromModal()">Save Evidence</button>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="evidence.css">
    <script src="evidence.js"></script>
    <script src="charts.js"></script>
    <script src="pdf-export.js"></script>
    <script>
        // Load questions from JSON and generate UI
        let assessmentData = {};
        let questionsData = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Load questions from JSON
            await loadQuestionsFromJSON();
            // Generate questions UI
            generateQuestionsUI();
            // Load saved data
            loadFromLocalStorage();
            // Update evidence indicators
            updateAllEvidenceIndicators();
            // Initialize charts
            initializeCharts();
            // Update charts with current data
            updateCharts();
        });
        
        async function loadQuestionsFromJSON() {
            try {
                const response = await fetch('data/questions.json');
                const data = await response.json();
                questionsData = data.domains;
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Error loading questions. Please refresh the page.');
            }
        }
        
        function generateQuestionsUI() {
            const container = document.getElementById('questionsContainer');
            if (!container || !questionsData) return;
            
            let html = '';
            
            Object.keys(questionsData).forEach(domainKey => {
                const domain = questionsData[domainKey];
                const domainNumber = domainKey.replace('domain', '');
                
                html += `
                    <div class="domain-section">
                        <div class="domain-header">
                            <h2 class="domain-title">Domain ${domainNumber}: ${domain.title}</h2>
                            <span class="domain-weight">Weight: ${(domain.weight * 100).toFixed(0)}%</span>
                        </div>
                `;
                
                Object.keys(domain.categories).forEach(categoryKey => {
                    const category = domain.categories[categoryKey];
                    
                    html += `
                        <div class="category-section">
                            <h3 class="category-title">${category.title}</h3>
                    `;
                    
                    category.questions.forEach(question => {
                        html += `
                            <div class="question-card" data-question-id="${question.id}">
                                <div class="question-header-row">
                                    <span class="question-number">${question.id.toUpperCase()}</span>
                                    ${question.requiresEvidence ? '<span class="evidence-required">ğŸ“ Evidence Required</span>' : ''}
                                </div>
                                <p class="question-text">${question.text}</p>
                                <div class="rating-scale">
                                    <label class="rating-option">
                                        <input type="radio" name="${question.id}" value="1" onchange="handleAnswerChange('${question.id}', 1)">
                                        <span class="rating-label">1 - Not Implemented</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="${question.id}" value="2" onchange="handleAnswerChange('${question.id}', 2)">
                                        <span class="rating-label">2 - Initial/Ad-hoc</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="${question.id}" value="3" onchange="handleAnswerChange('${question.id}', 3)">
                                        <span class="rating-label">3 - Defined/Repeatable</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="${question.id}" value="4" onchange="handleAnswerChange('${question.id}', 4)">
                                        <span class="rating-label">4 - Managed/Measured</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="${question.id}" value="5" onchange="handleAnswerChange('${question.id}', 5)">
                                        <span class="rating-label">5 - Optimized/Innovating</span>
                                    </label>
                                </div>
                                <button class="evidence-btn" data-evidence-indicator="${question.id}" onclick="openEvidenceModal('${question.id}')">
                                    ğŸ“ Add Evidence
                                </button>
                            </div>
                        `;
                    });
                    
                    html += `</div>`; // Close category-section
                });
                
                html += `</div>`; // Close domain-section
            });
            
            container.innerHTML = html;
        }
        
        function handleAnswerChange(questionId, value) {
            assessmentData[questionId] = parseInt(value);
            saveToLocalStorage();
            updateProgress();
            updateCharts();
        }
        
        function saveToLocalStorage() {
            try {
                localStorage.setItem(CONFIG.assessment.storageKey, JSON.stringify(assessmentData));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem(CONFIG.assessment.storageKey);
                if (saved) {
                    assessmentData = JSON.parse(saved);
                    console.log('Loaded assessment data:', assessmentData);
                    
                    // Restore radio button selections
                    Object.keys(assessmentData).forEach(questionId => {
                        const value = assessmentData[questionId];
                        const radio = document.querySelector(`input[name="${questionId}"][value="${value}"]`);
                        if (radio) {
                            radio.checked = true;
                        }
                    });
                    
                    updateProgress();
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }
        
        function updateProgress() {
            if (!questionsData) return;
            
            let totalQuestions = 0;
            let answeredQuestions = 0;
            
            Object.keys(questionsData).forEach(domainKey => {
                const domain = questionsData[domainKey];
                Object.keys(domain.categories).forEach(categoryKey => {
                    const category = domain.categories[categoryKey];
                    category.questions.forEach(question => {
                        totalQuestions++;
                        if (assessmentData[question.id] !== undefined) {
                            answeredQuestions++;
                        }
                    });
                });
            });
            
            const percentage = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercentage = document.getElementById('progressPercentage');
            
            if (progressBar) progressBar.style.width = percentage + '%';
            if (progressText) progressText.textContent = `${answeredQuestions}/${totalQuestions} Questions`;
            if (progressPercentage) progressPercentage.textContent = percentage + '%';
        }
        
        function updateAllEvidenceIndicators() {
            if (!questionsData) return;
            
            Object.keys(questionsData).forEach(domainKey => {
                const domain = questionsData[domainKey];
                Object.keys(domain.categories).forEach(categoryKey => {
                    const category = domain.categories[categoryKey];
                    category.questions.forEach(question => {
                        updateEvidenceIndicator(question.id);
                    });
                });
            });
        }
        
        function updateEvidenceIndicator(questionId) {
            evidenceManager.getEvidence(questionId).then(evidence => {
                const indicator = document.querySelector(`[data-evidence-indicator="${questionId}"]`);
                if (indicator) {
                    if (evidence && (evidence.text || (evidence.images && evidence.images.length > 0))) {
                        indicator.classList.add('has-evidence');
                        indicator.textContent = 'ğŸ“ Evidence Added';
                    } else {
                        indicator.classList.remove('has-evidence');
                        indicator.textContent = 'ğŸ“ Add Evidence';
                    }
                }
            });
        }
        
        function reloadAssessment() {
            loadFromLocalStorage();
            updateAllEvidenceIndicators();
            alert('âœ… Assessment data reloaded!\n\nAll imported answers and evidence are now visible.');
        }
        
        function showSection(section) {
            // Tab switching logic
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            const sectionEl = document.getElementById(section);
            if (sectionEl) {
                sectionEl.classList.add('active');
            }
            
            // Update active tab
            event.target.classList.add('active');
            
            // Update charts when switching to dashboard or other visual sections
            if (section === 'dashboard' || section === 'maturity' || section === 'compliance' || section === 'roadmap') {
                setTimeout(() => updateCharts(), 100);
            }
        }
    </script>
</body>
</html>